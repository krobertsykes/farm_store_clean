{% extends "store/base.html" %}
{% load static %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">Your Cart</h1>

{% if not items %}
  <p>Your cart is empty.</p>
  <a href="{% url 'store:catalogue' %}" class="text-blue-600 underline">
    Continue shopping
  </a>
{% else %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Place Order (sticky left) -->
  <aside class="lg:col-span-1">
    <div class="sticky top-4">
      <div class="bg-white rounded-lg shadow p-4">
        <h2 class="text-xl font-semibold mb-3">Place Order</h2>
        <form method="post" action="{% url 'store:checkout' %}" class="space-y-3">
          {% csrf_token %}

          <!-- Email (required) -->
          <label class="block text-sm font-medium">Email <span class="text-red-600">*</span></label>
          <input type="email" name="email" required
                 value="{{ checkout_form.initial.email|default_if_none:'' }}"
                 class="w-full rounded border border-gray-300 bg-gray-50 px-3 py-2"
                 placeholder="you@example.com">

          <!-- Phone (optional, SMS disclaimer) -->
          <label class="block text-sm font-medium">Phone (for SMS)</label>
          <input type="text" name="phone"
                 value="{{ checkout_form.initial.phone|default_if_none:'' }}"
                 class="w-full rounded border border-gray-300 bg-gray-50 px-3 py-2"
                 placeholder="555-123-4567">
          <p class="text-xs text-gray-500">Standard SMS rates may apply.</p>

          <!-- Payment method (Cash, Venmo, Zelle, Card) -->
          <label class="block text-sm font-medium">Payment method</label>
          <select name="payment_method" class="w-full rounded border border-gray-300 bg-white px-3 py-2">
            <option value="cash">Cash on delivery</option>
            <option value="venmo">Venmo</option>
            <option value="zelle">Zelle</option>
            <option value="card">Credit/Debit Card</option>
          </select>

          <button type="submit"
                  class="w-full bg-green-600 hover:bg-green-700 text-white rounded px-4 py-2">
            Place Order
          </button>

          {% if not user.is_authenticated %}
            <div class="pt-2 text-sm">
              <a href="{% url 'accounts:signup' %}" class="text-blue-700 underline">Create an account</a>
              <span class="text-gray-600">or</span>
              <span class="text-gray-800">checkout as guest</span>
            </div>
          {% endif %}
        </form>
      </div>
    </div>
  </aside>

  <!-- Cart items / totals -->
  <section class="lg:col-span-2">

    <table class="w-full text-left mb-6" id="cart-form">
      <thead>
        <tr class="border-b font-semibold">
          <th>Product</th>
          <th>Image</th>
          <th>Unit price</th>
          <th>Remaining</th>
          <th>Qty</th>
          <th>Line&nbsp;total</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
          {% with p=it.product %}
          <tr class="border-b align-middle" data-id="{{ p.id }}">
            <td class="py-2">{{ p.name }}</td>
            <td class="py-2">
              {% if p.images.all %}
                <img src="{{ p.images.all.0.image.url }}"
                     class="rounded" style="width:60px; height:auto;">
              {% else %}
                &ndash;
              {% endif %}
            </td>
            <td class="py-2">
              {# show sale formatting but expose effective price in data attribute for JS #}
              {% if p.sale_price and p.sale_price < p.price %}
                <span class="text-gray-500 line-through mr-1">${{ p.price|floatformat:"2" }}</span>
                <strong class="unit-price">${{ it.unit_price|floatformat:"2" }}</strong>
              {% else %}
                <strong class="unit-price">${{ it.unit_price|floatformat:"2" }}</strong>
              {% endif %}
              <span class="text-sm text-gray-600">
                {% if p.unit == 'ea' %} each
                {% elif p.unit == 'lb' %} per pound
                {% elif p.unit == 'oz' %} per ounce
                {% elif p.unit == 'kg' %} per kilogram
                {% endif %}
              </span>
              <span class="hidden" data-unit-price="{{ it.unit_price }}"></span>
            </td>

            {# Remaining: views ensures no decimals if unit == 'ea' #}
            <td class="py-2"><span class="remain">{{ it.remaining }}</span></td>

            <td class="py-2">
              <input type="number"
                     name="qty"
                     value="{{ it.qty }}"
                     min="0"
                     max="{{ p.stock_qty }}"
                     {% if p.unit == 'ea' %}
                       step="1"
                     {% elif p.unit == 'lb' %}
                       step="0.5"
                     {% elif p.unit == 'oz' %}
                       step="1"
                     {% else %}
                       step="0.25"
                     {% endif %}
                     class="border w-20 p-1 rounded qty-input">
            </td>
            <td class="py-2 line-total">${{ it.line_total|floatformat:"2" }}</td>
            <td class="py-2">
              <form action="{% url 'store:remove_from_cart' p.id %}" method="post">
                {% csrf_token %}
                <button class="text-red-600">âœ•</button>
              </form>
            </td>
          </tr>
          {% endwith %}
        {% endfor %}
      </tbody>

      <tfoot>
        <tr>
          <td colspan="5" class="text-right py-2 pr-4 text-gray-700">Subtotal</td>
          <td class="py-2">$<span id="cart-subtotal">{{ subtotal|floatformat:"2" }}</span></td>
          <td></td>
        </tr>

        <tr>
          <td colspan="5" class="text-right py-2 pr-4">
            <div class="inline-flex items-center gap-2">
              <form class="inline-flex items-center gap-2" method="post" action="{% url 'store:apply_coupon' %}">
                {% csrf_token %}
                {# Max 8 chars client-side too #}
                <input type="text" name="code" maxlength="8"
                       class="border rounded px-2 py-1"
                       placeholder="Coupon code">
                <button class="bg-gray-800 text-white rounded px-3 py-1 text-sm">Apply</button>
              </form>

              {% if coupon %}
                <form id="clear-coupon" class="inline" method="post" action="{% url 'store:apply_coupon' %}">
                  {% csrf_token %}
                  <input type="hidden" name="code" value="">
                  <button class="text-blue-600 underline">remove</button>
                </form>
              {% endif %}
            </div>

            {# Inline coupon messages only #}
            {% if coupon_error %}
              <div class="text-red-600 text-sm mt-1">{{ coupon_error }}</div>
            {% endif %}
            {% if coupon_success %}
              <div class="text-green-700 text-sm mt-1">{{ coupon_success }}</div>
            {% endif %}
          </td>

          <td class="py-2">
            -$<span id="cart-discount">{{ discount|floatformat:"2" }}</span>
          </td>
          <td></td>
        </tr>

        <tr class="font-semibold">
          <td colspan="5" class="text-right py-2 pr-4">Total</td>
          <td class="py-2">$<span id="cart-total">{{ total|floatformat:"2" }}</span></td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <div class="flex items-center justify-between">
      <a href="{% url 'store:catalogue' %}" class="text-blue-600 underline">
        Continue shopping
      </a>
      <a href="{% url 'store:checkout' %}" class="bg-green-600 hover:bg-green-700 text-white rounded px-4 py-2">
        Checkout
      </a>
    </div>

  </section>
</div>
{% endif %}

<script>
function getCookie(name) {
  return document.cookie.split('; ').find(c => c.startsWith(name + '='))?.split('=')[1];
}

// recompute table sums after any row change
function recalcTotals() {
  let subtotal = 0;
  document.querySelectorAll("#cart-form tbody tr").forEach(tr => {
    const lt = tr.querySelector(".line-total")?.textContent || "$0";
    const n  = parseFloat(lt.replace(/[^0-9.]/g,'') || "0");
    subtotal += n;
  });
  const discount = parseFloat(document.getElementById("cart-discount")?.textContent || "0");
  document.getElementById("cart-subtotal").textContent = subtotal.toFixed(2);
  document.getElementById("cart-total").textContent = Math.max(0, subtotal - discount).toFixed(2);
}

document.querySelectorAll(".qty-input").forEach(inp => {
  let timer = null;
  inp.addEventListener("input", () => {
    clearTimeout(timer);
    timer = setTimeout(() => {
      let val = parseFloat(inp.value) || 0;
      const max = parseFloat(inp.max);
      if (val > max) val = max;
      inp.value = val;

      const tr = inp.closest("tr");
      const id = tr.dataset.id;

      fetch(`/cart/update/${id}/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCookie("csrftoken"),
          "X-Requested-With": "XMLHttpRequest"
        },
        body: `qty=${val}`
      })
      .then(r => r.json())
      .then(js => {
        if (!js.ok) return;
        tr.querySelector(".remain").textContent = js.remaining;

        // Use EFFECTIVE unit price from data attribute
        const unitPrice = parseFloat(tr.querySelector("[data-unit-price]")?.getAttribute("data-unit-price") || "0");
        tr.querySelector(".line-total").textContent = `$${(unitPrice * val).toFixed(2)}`;

        // Subtotal/Total recalc on the client
        recalcTotals();

        // Update header cart count using server's cart_total
        const cartCount = document.getElementById("cart-count");
        if (cartCount && typeof js.cart_total !== "undefined") {
          cartCount.textContent = js.cart_total;
        }
      });
    }, 250);
  });
});

// (Optional) remove forms can post normally; left as-is intentionally
</script>
{% endblock %}
