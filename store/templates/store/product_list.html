{% extends "store/base.html" %}
{% load static %}

{% block content %}
<div class="flex justify-between items-center mb-6">
  <h1 class="text-3xl font-bold">Fresh Produce</h1>
  {% if not show_oos %}
    {% if has_oos %}
      <a href="{% url 'store:catalogue' %}?oos=1" class="text-blue-600 underline">Show out-of-stock</a>
    {% else %}
      <span class="text-gray-400 cursor-not-allowed">Show out-of-stock</span>
    {% endif %}
  {% else %}
    <a href="{% url 'store:catalogue' %}?oos=0" class="text-blue-600 underline">Hide out-of-stock</a>
  {% endif %}
</div>

{% for category in categories %}
  <h2 class="text-2xl font-semibold mt-10 mb-4">{{ category.name }}</h2>
  {% if category.description %}
    <p class="mb-4 text-gray-600">{{ category.description }}</p>
  {% endif %}

  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
    {% for product in category.visible_products %}
      {% with rem=product.remaining|floatformat:"0" %}
      <div id="prod-{{ product.id }}"
           class="rounded-lg shadow p-4 text-center {% if rem == '0' and not product.in_cart %}bg-gray-200 text-gray-500{% endif %}">

        {% with imgs=product.images.all %}
          {% if imgs %}
            <div x-data="{ src: '{{ imgs.0.image.url }}' }" class="flex flex-col items-center mb-3">
              <img :src="src" class="rounded h-44 w-full object-cover {% if rem == '0' and not product.in_cart %}opacity-50{% endif %}">
              {% if imgs|length > 1 %}
                <div class="flex gap-2 mt-2">
                  {% for pic in imgs %}
                    <img src="{{ pic.image.url }}"
                         class="w-16 h-16 rounded cursor-pointer border hover:ring-2 hover:ring-green-500"
                         @click="src='{{ pic.image.url }}'">
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          {% endif %}
        {% endwith %}

        <h3 class="font-bold mb-1">{{ product.name }}</h3>

        {# SALE/REGULAR PRICE DISPLAY (kept) #}
        {% if product.sale_price and product.sale_price < product.price %}
          <p class="text-lg font-semibold mb-1">
            <span class="text-gray-500 line-through mr-2">${{ product.price|floatformat:"2" }}</span>
            <span class="text-red-600">${{ product.sale_price|floatformat:"2" }}</span>
            {% if product.unit == 'ea' %} each
            {% elif product.unit == 'lb' %} per pound
            {% elif product.unit == 'oz' %} per ounce
            {% elif product.unit == 'kg' %} /kg
            {% endif %}
          </p>
        {% else %}
          <p class="text-lg font-semibold mb-1">
            ${{ product.price|floatformat:"2" }}
            {% if product.unit == 'ea' %} each
            {% elif product.unit == 'lb' %} per pound
            {% elif product.unit == 'oz' %} per ounce
            {% elif product.unit == 'kg' %} /kg
            {% endif %}
          </p>
        {% endif %}

        {# RATINGS: overall avg (click for breakdown) + "your rating" strip #}
        <div class="mb-2 flex items-center justify-center gap-3">
          <a href="{% url 'store:reviews_detail' product.id %}"
             class="text-sm text-yellow-700 underline"
             title="See rating breakdown and comments">
             ★ {{ product.avg_stars|floatformat:1 }}
          </a>

          {% if user.is_authenticated %}
            <span class="flex items-center gap-1 text-sm">
              <span class="text-gray-600">Your:</span>
              <span class="inline-flex">
                {% for i in "12345" %}
                  {% with k=forloop.counter %}
                    {% if product.user_stars|default:0 >= k %}
                      <svg class="w-4 h-4" viewBox="0 0 20 20" fill="#F59E0B" aria-hidden="true"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.09 3.355a1 1 0 00.95.69h3.527c.969 0 1.371 1.24.588 1.81l-2.855 2.074a1 1 0 00-.364 1.118l1.09 3.356c.3.921-.755 1.688-1.54 1.118l-2.855-2.074a1 1 0 00-1.176 0l-2.855 2.074c-.784.57-1.838-.197-1.539-1.118l1.09-3.356a1 1 0 00-.364-1.118L2.844 8.782c-.783-.57-.38-1.81.588-1.81h3.527a1 1 0 00.95-.69l1.09-3.355z"/></svg>
                    {% else %}
                      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="#F59E0B"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z"/></svg>
                    {% endif %}
                  {% endwith %}
                {% endfor %}
              </span>
            </span>
          {% endif %}
        </div>

        {# CLICKABLE 5-STAR INPUT (server enforces must-be-logged-in + must-have-purchased) #}
        {% if user.is_authenticated %}
          <div class="mt-1 flex items-center justify-center gap-1" aria-label="Rate this product">
            {% for i in "12345" %}
              {% with k=forloop.counter %}
              <button type="button" class="rate-btn" data-pid="{{ product.id }}" data-stars="{{ k }}"
                      title="Set {{ k }} star{% if k != 1 %}s{% endif %}">
                {% if product.user_stars|default:0 >= k %}
                  <svg class="w-5 h-5" viewBox="0 0 20 20" fill="#F59E0B"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.09 3.355a1 1 0 00.95.69h3.527c.969 0 1.371 1.24.588 1.81l-2.855 2.074a1 1 0 00-.364 1.118l1.09 3.356c.3.921-.755 1.688-1.54 1.118l-2.855-2.074a1 1 0 00-1.176 0l-2.855 2.074c-.784.57-1.838-.197-1.539-1.118l1.09-3.356a1 1 0 00-.364-1.118L2.844 8.782c-.783-.57-.38-1.81.588-1.81h3.527a1 1 0 00.95-.69l1.09-3.355z"/></svg>
                {% else %}
                  <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="#F59E0B"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z"/></svg>
                {% endif %}
              </button>
              {% endwith %}
            {% endfor %}
          </div>
        {% endif %}

        <p class="text-sm mb-4 mt-2">
          Remaining: <span class="remain">{{ rem }}</span>
          {% if product.unit != 'ea' and rem != '0' %}
            {% if product.unit == 'lb' %}/lb{% elif product.unit == 'oz' %}/oz{% elif product.unit == 'kg' %}/kg{% endif %}
          {% endif %}
        </p>

        {# IMPORTANT: keep controls visible if user has some in cart, even when remaining == 0 #}
        {% if rem != '0' or product.in_cart > 0 %}
        <form class="add-form relative flex items-center justify-center gap-2"
              data-pid="{{ product.id }}"
              data-unit="{{ product.unit }}"
              data-initial-in-cart="{{ product.in_cart|default:0 }}"
              data-price="{{ product.effective_price }}"
              data-url-update="{% url 'store:update_qty' product.id %}"
              method="post">
          {% csrf_token %}

          <button type="button"
                  class="ycps w-10 h-10 rounded-full bg-yellow-400 hover:bg-yellow-500 active:bg-yellow-600 text-black text-xl font-bold flex items-center justify-center shadow border border-yellow-500"
                  aria-label="Add to cart">+</button>

          {% if product.unit == 'ea' %}
          <div class="stepper hidden items-center gap-3 px-3 py-1 rounded-full border border-yellow-400 bg-yellow-100">
            <button type="button" class="btn-dec text-2xl leading-none px-2">−</button>
            <span class="stepper-count min-w-6 text-lg font-semibold text-black text-center">1</span>
            <button type="button" class="btn-inc text-2xl leading-none px-2">+</button>
          </div>
          {% endif %}

          {% if product.unit != 'ea' %}
            <div class="weight-stepper hidden flex items-center gap-2 px-3 py-1 rounded-full border border-yellow-400 bg-yellow-100 whitespace-nowrap">
              <button type="button" class="wdec text-2xl leading-none px-2">−</button>
              <span class="wqty min-w-12 text-center font-semibold">0</span>
              <span class="wunit text-sm"></span>
              <button type="button" class="wcaret px-1" title="Change amount">
                <svg class="w-4 h-4 opacity-60" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"/></svg>
              </button>
              <button type="button" class="winc text-2xl leading-none px-2">+</button>
            </div>

            <div class="weight-panel hidden absolute top-full mt-2 left-1/2 -translate-x-1/2 z-30 bg-white border rounded shadow-lg w-48 text-left"></div>

            <div class="weight-confirm hidden absolute top-full mt-2 left-1/2 -translate-x-1/2 z-20 bg-white border rounded shadow-lg p-3 w-64 text-left">
              <div class="mb-2">
                <span class="font-medium">Qty:</span>
                <span class="chosen font-semibold"></span>
              </div>
              <div class="text-sm text-gray-700 mb-3">
                Total est. price: <span class="est-price font-semibold"></span><br>
                <span class="text-gray-500">Final cost by actual weight</span>
              </div>
              <button type="button" class="btn-add w-full rounded-full bg-yellow-400 hover:bg-yellow-500 active:bg-yellow-600 text-black font-semibold py-2">Add to Cart</button>
            </div>
          {% endif %}
        </form>
        {% endif %}
      </div>
      {% endwith %}
    {% endfor %}
  </div>
{% endfor %}

<script>
  function getCSRF(){
    return document.cookie.split('; ').find(c=>c.startsWith('csrftoken='))?.split('=')[1]
  }
  function postUpdateQty(url,qty){
    const data=new FormData(); data.append('qty',String(qty));
    return fetch(url,{ method:'POST', headers:{'X-CSRFToken':getCSRF(),'X-Requested-With':'XMLHttpRequest'}, body:data }).then(r=>r.json());
  }

  // Clickable star rating (logged-in users). Server enforces "must have purchased".
  document.querySelectorAll('.rate-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const pid = btn.dataset.pid, stars = btn.dataset.stars;
      fetch(`/product/${pid}/rate/`, {
        method: 'POST',
        headers: {'X-CSRFToken': getCSRF(), 'X-Requested-With':'XMLHttpRequest'},
        body: new URLSearchParams({stars})
      }).then(()=>{
        // Optimistic fill update
        const wrap = btn.parentElement;
        wrap.querySelectorAll('.rate-btn').forEach(b=>{
          const k = parseInt(b.dataset.stars,10);
          const svg = b.querySelector('svg');
          if(k <= parseInt(stars,10)){
            svg.setAttribute('fill','#F59E0B'); svg.setAttribute('stroke','none');
          }else{
            svg.setAttribute('fill','none'); svg.setAttribute('stroke','#F59E0B');
          }
        });
      });
    });
  });

  // Your original add-to-cart JS (unchanged)
  document.querySelectorAll('.add-form').forEach(form=>{
    const pid   = form.dataset.pid;
    const unit  = form.dataset.unit;
    const price = Number(form.dataset.price||'0');
    const url   = form.dataset.urlUpdate;
    let inCart  = Number(form.dataset.initialInCart||'0');

    const card     = document.getElementById('prod-'+pid);
    const remainEl = card.querySelector('.remain');

    const ycps   = form.querySelector('.ycps');
    const stepEl = form.querySelector('.stepper');
    const inc    = form.querySelector('.btn-inc');
    const dec    = form.querySelector('.btn-dec');
    const countEl= form.querySelector('.stepper-count');

    const wStep  = form.querySelector('.weight-stepper');
    const winc   = wStep ? wStep.querySelector('.winc') : null;
    const wdec   = wStep ? wStep.querySelector('.wdec') : null;
    const wqty   = wStep ? wStep.querySelector('.wqty') : null;
    const wunit  = wStep ? wStep.querySelector('.wunit') : null;
    const wcaret = wStep ? wStep.querySelector('.wcaret') : null;

    const panel  = form.querySelector('.weight-panel');
    const confirm= form.querySelector('.weight-confirm');
    const chosen = confirm ? confirm.querySelector('.chosen') : null;
    const est    = confirm ? confirm.querySelector('.est-price') : null;
    const addBtn = confirm ? confirm.querySelector('.btn-add') : null;

    let pickToAdd = 0;

    function rem(){ return Number((remainEl?.textContent||'0').replace(/[^\d.]/g,'')) }
    function absMax(){ return inCart + rem() }
    function setRemainText(v){
      if(unit==='ea'){ const n = parseInt(v,10); remainEl.textContent = Number.isNaN(n) ? v : String(n); }
      else { remainEl.textContent = v; }
    }
    function stepInfo(){ if(unit==='lb') return {step:0.5, hard:5}; if(unit==='oz') return {step:1, hard:Infinity}; if(unit==='kg') return {step:0.25, hard:5}; return {step:1, hard:Infinity}; }
    function fmt(q){ return unit==='oz' ? `${q} oz` : `${q} ${unit}` }

    function applyUpdate(js,newQty){
      if(typeof js.remaining!=='undefined') setRemainText(js.remaining);
      inCart = Number(newQty);

      if(unit==='ea'){
        if(inCart>0){ stepEl.classList.remove('hidden'); ycps.classList.add('hidden'); countEl.textContent = String(Math.floor(inCart)); }
        else { stepEl.classList.add('hidden'); ycps.classList.remove('hidden'); }
      } else {
        if(inCart>0){
          ycps.classList.add('hidden'); panel.classList.add('hidden'); confirm.classList.add('hidden'); wStep.classList.remove('hidden');
          wqty.textContent = String(unit==='oz' ? Math.round(inCart) : Number(inCart.toFixed(2)).toString().replace(/\.00$/,''));
          wunit.textContent = unit;
        } else {
          wStep.classList.add('hidden'); ycps.classList.remove('hidden'); panel.classList.add('hidden'); confirm.classList.add('hidden');
        }
      }

      const counter = document.getElementById('cart-count');
      if(counter && typeof js.cart_total!=='undefined') counter.textContent = js.cart_total;

      if (String(js.remaining) === '0' && Number(inCart) <= 0) {
        form.remove();
        const out = document.createElement('p'); out.className = 'text-red-600 font-semibold mt-3'; out.innerText = 'Out of stock';
        card.appendChild(out); card.classList.add('bg-gray-200','text-gray-500');
      }
    }

    function buildList(mode){
      panel.innerHTML = '';
      const {step, hard} = stepInfo(); const remaining = rem();
      if(mode==='add' && remaining<=0){ panel.classList.add('hidden'); return; }
      let start = step, end = (mode==='add') ? Math.min(remaining, hard) : Math.min(absMax(), hard);
      if(end < start - 1e-9){ panel.classList.add('hidden'); return; }

      let first = null;
      for(let q=start; q<=end + 1e-9; q=Math.round((q+step)*1000)/1000){
        if(first===null) first = q;
        const row = document.createElement('button'); row.type='button'; row.className='block w-full text-left px-3 py-2 hover:bg-yellow-100'; row.textContent = fmt(q);
        row.addEventListener('mouseenter', ()=>{ const hp = panel.querySelector('.hover-price'); if(hp) hp.textContent = `$${(price*q).toFixed(2)}`; });
        row.addEventListener('click', ()=>{
          if(mode==='add'){ pickToAdd = Math.min(q, rem()); panel.classList.add('hidden'); confirm.classList.remove('hidden'); chosen.textContent = fmt(pickToAdd); est.textContent = `$${(price*pickToAdd).toFixed(2)}`; }
          else { const target = Math.min(q, absMax()); postUpdateQty(url, target).then(js=>{ if(js?.ok) applyUpdate(js, target); }); panel.classList.add('hidden'); }
        });
        panel.appendChild(row);
      }
      const footer = document.createElement('div'); footer.className='px-3 py-2 text-sm text-gray-700 border-t';
      footer.innerHTML = `<div>Total est. price: <span class="hover-price font-semibold">$${(price*(first||0)).toFixed(2)}</span></div><div class="text-gray-500">Final cost by actual weight</div>`;
      panel.appendChild(footer);
    }

    if(unit==='ea'){ if(inCart>0){ ycps.classList.add('hidden'); stepEl.classList.remove('hidden'); countEl.textContent = String(Math.floor(inCart)); } }
    else { if(inCart>0){ ycps.classList.add('hidden'); wStep.classList.remove('hidden'); wqty.textContent = String(inCart); wunit.textContent = unit; } }

    ycps?.addEventListener('click', e=>{
      e.preventDefault();
      if(unit==='ea'){ if(rem()<=0) return; ycps.classList.add('hidden'); stepEl.classList.remove('hidden'); const target = Math.min(inCart+1, absMax()); countEl.textContent = String(target); postUpdateQty(url, target).then(js=>{ if(js?.ok) applyUpdate(js, target); }); }
      else { ycps.classList.add('hidden'); buildList('add'); panel.classList.remove('hidden'); confirm.classList.add('hidden'); }
    });

    inc?.addEventListener('click', e=>{ e.preventDefault(); const target = Math.min(inCart+1, absMax()); if(target===inCart) return; postUpdateQty(url, target).then(js=>{ if(js?.ok) applyUpdate(js, target); }); });
    dec?.addEventListener('click', e=>{ e.preventDefault(); const target = Math.max(0, inCart-1); postUpdateQty(url, target).then(js=>{ if(js?.ok) applyUpdate(js, target); }); });

    wcaret?.addEventListener('click', ()=>{ buildList('absolute'); panel.classList.remove('hidden'); confirm.classList.add('hidden'); });
    addBtn?.addEventListener('click', ()=>{ if(pickToAdd<=0) return; const target = Math.min(absMax(), inCart + pickToAdd); postUpdateQty(url, target).then(js=>{ if(js?.ok) applyUpdate(js, target); }); });

    function weightStep(){ return stepInfo().step; }
    winc?.addEventListener('click', ()=>{ const target = Math.min(absMax(), inCart + weightStep()); if(target===inCart) return; postUpdateQty(url, target).then(js=>{ if(js?.ok) applyUpdate(js, target); }); });
    wdec?.addEventListener('click', ()=>{ const target = Math.max(0, inCart - weightStep()); postUpdateQty(url, target).then(js=>{ if(js?.ok) applyUpdate(js, target); }); });

    document.addEventListener('click', (ev)=>{ const listOpen = panel && !panel.classList.contains('hidden'); const confirmOpen = confirm && !confirm.classList.contains('hidden'); if(!listOpen && !confirmOpen) return; if(form.contains(ev.target)) return; if(panel) panel.classList.add('hidden'); if(confirm) confirm.classList.add('hidden');
      if(unit==='ea'){ if(inCart>0){ stepEl.classList.remove('hidden'); ycps.classList.add('hidden'); } else { ycps.classList.remove('hidden'); stepEl.classList.add('hidden'); } }
      else { if(inCart>0){ wStep.classList.remove('hidden'); ycps.classList.add('hidden'); } else { ycps.classList.remove('hidden'); } }
    });

    form.addEventListener('submit', e=>e.preventDefault());
  });
</script>
{% endblock %}
