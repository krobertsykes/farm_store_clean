{% extends "store/base.html" %}
{% load static %}

{% block content %}
<div class="flex justify-between items-center mb-6">
  <span id="fav-state" data-count="{{ fav_count|default:0 }}" class="hidden"></span>
  <h1 class="text-3xl font-bold">Fresh Produce</h1>

  <div class="flex items-center gap-5">
    {# OOS toggle #}
    {% if not show_oos %}
      {% if has_oos %}
        <span class="text-gray-400 cursor-not-allowed">Show out-of-stock</span>
      {% else %}
        <span class="text-gray-400 cursor-not-allowed">Show out-of-stock</span>
      {% endif %}
    {% else %}
      <a href="?{% if q %}q={{ q|urlencode }}&{% endif %}{% if show_fav %}fav=1&{% endif %}oos=0" class="text-sm underline text-gray-700">Hide out-of-stock</a>
    {% endif %}

    {# Favorites filter toggle #}
    {% if show_fav %}
      <a href="?{% if q %}q={{ q|urlencode }}&{% endif %}{% if show_oos %}oos=1&{% endif %}" class="text-sm underline text-gray-700" id="fav-toggle-link">Show all</a>
    {% else %}
      {% if has_favorites %}
        <a href="?{% if q %}q={{ q|urlencode }}&{% endif %}{% if show_oos %}oos=1&{% endif %}fav=1" class="text-sm underline text-gray-700" id="fav-toggle-link">Only favorites</a>
      {% else %}
        <span class="text-sm text-gray-400 cursor-not-allowed" id="fav-toggle-disabled">Only favorites</span>
      {% endif %}
    {% endif %}
  </div>
</div>

{% for category in categories %}
  <h2 class="text-2xl font-semibold mt-10 mb-4">{{ category.name }}</h2>
  {% if category.description %}
    <p class="mb-4 text-gray-600">{{ category.description }}</p>
  {% endif %}

  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
    {% for product in category.visible_products %}
      {% include "store/partials/product_card.html" with product=product rem=product.remaining|floatformat:"0" %}
    {% endfor %}
  </div>
{% endfor %}

{# Prevent the weight list popover from being visually clipped by container overflow #}
<style>
  .weight-panel { max-height: none !important; overflow: visible !important; }
</style>

{# IMPORTANT: Load behavior JS INSIDE this content block so it actually renders #}
{% load static %}
<script src="{% static 'store/js/fresh_produce.js' %}" defer></script>
<script src="{% static 'store/js/ycps_gate.js' %}" defer></script>
<script src="{% static 'store/js/rating_gate.js' %}" defer></script>

<script>
/*
  Fallback repaint in case defer/ordering timing delays the external gate binding.
  This does nothing harmful if the external file already bound handlers.
*/
(function(){
  if (window.__rating_gate_file_ver) {
    console.log('[rating_gate] version detected:', window.__rating_gate_file_ver);
    if (typeof window.__rg_repaint === 'function') window.__rg_repaint();
    return;
  }
  // If the external file hasnâ€™t executed yet, wait for DOM, then try repaint soon after.
  document.addEventListener('DOMContentLoaded', function(){
    setTimeout(function(){
      console.log('[rating_gate] inline fallback firing (no version detected)');
      if (typeof window.__rg_repaint === 'function') window.__rg_repaint();
    }, 0);
  });
})();
</script>

{% endblock %}
